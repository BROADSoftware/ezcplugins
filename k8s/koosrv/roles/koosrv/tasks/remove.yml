

# ---------------------------------------------------------------------------
- name: koosrv pod removal
  block:
  
  - name: Install k8s ansible module required package
    yum: name=python2-openshift state=present
      
  - name: Copy koosrv deployment manifest
    template:
      src: koosrv.yaml
      dest: "{{koosrv_tmp}}/koosrv.yaml" 
  
  - name: Delete koosrv deployment
    k8s:
      state: absent
      src: "{{koosrv_tmp}}/koosrv.yaml" 
          
   # This will also remove secrets 
  - name: Remove {{koosrv_namespace}} namespace
    k8s:
      state: absent
      definition:
        apiVersion: v1
        kind: Namespace
        metadata:
          name: "{{koosrv_namespace}}"
  
  run_once: true
  when: koosrv_deploy_pod

# ---------------------------------------------------------------------------
- name: API server clean configuration
  block:       
  - name: Unconfigure kube api server (1/4)
    lineinfile:
      path: /etc/kubernetes/manifests/kube-apiserver.yaml
      regexp: "{{ item.regexp }}"
      state: absent
    with_items:
    - { regexp: '^.*authentication-token-webhook-config-file.*' }
    - { regexp: '^.*authentication-token-webhook-cache-ttl.*' }

  # Restore original line (--runtime-config=)
  - name: Unconfigure kube api server(2/4)
    lineinfile:
      path: /etc/kubernetes/manifests/kube-apiserver.yaml
      regexp: "{{ item.regexp }}"
      line: "{{ item.line }}"
      insertafter: '^.*- kube-apiserver'
    with_items:
    - { line: '    - --runtime-config=', regexp: '^.*runtime-config.*' }
        
  - name: Unconfigure kube api server (3/4)
    blockinfile:
      path: /etc/kubernetes/manifests/kube-apiserver.yaml
      marker: "# Ansible koo config 1/3 hacking {mark}"
      state: absent      
      
  - name: Unconfigure kube api server (4/3)
    blockinfile:
      path: /etc/kubernetes/manifests/kube-apiserver.yaml
      marker: "# Ansible koo config 2/3 hacking {mark}"      
      state: absent      
        
  - name: Remove koo config folder
    file:
      state: absent
      path: /etc/kubernetes/koo
      
  when: koosrv_configure_apiserver  
  
  